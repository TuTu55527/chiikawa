<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>訂單管理</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; padding: 20px; }
    h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
    form { background: #fff; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: inline-block; width: 120px; font-weight: bold; margin-bottom: 5px; }
    input, select { padding: 6px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; width: calc(100% - 130px); }
    input[type="submit"], button { width: auto; background: #007bff; color: white; border: none; cursor: pointer; padding: 6px 12px; border-radius: 4px; margin-top: 5px; }
    input[type="submit"]:hover, button:hover { background: #0056b3; }
    #result { margin-top: 15px; }
    .order-card { background: #fff; border-radius: 8px; padding: 10px; margin: 10px 0; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .order-info { max-width: 80%; }
    .unpaid { color: red; font-weight: bold; }
    .stats { background: #fff; padding: 10px; margin-top: 15px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .export-btn { margin-top: 10px; background: #28a745; }
    .export-btn:hover { background: #1e7e34; }
  </style>
</head>
<body>
  <h2>🔒 輸入密碼登入</h2>
  <input type="password" id="passwordInput" placeholder="請輸入密碼">
  <button onclick="checkPassword()">登入</button>

  <div id="app" style="display:none;">
    <h2>新增訂單</h2>
    <form id="orderForm">
      <!-- 姓名 -->
      <label>姓名：</label>
      <select id="orderNameSelect" name="name" required>
        <option value="">-- 請選擇姓名 --</option>
        <option value="__new__">➕ 新增姓名</option>
      </select>
      <input type="text" id="newNameInput" placeholder="輸入新姓名" style="display:none;">
      <br>

      <!-- 品項 -->
      <label>品項：</label>
      <select id="orderItemSelect" name="item" required>
        <option value="">-- 請選擇品項 --</option>
        <option value="__new__">➕ 新增品項</option>
      </select>
      <input type="text" id="newItemInput" placeholder="輸入新品項" style="display:none;">
      <br>

      <!-- 描述 -->
      <label>描述：</label>
      <select id="orderDescSelect" name="desc">
        <option value="">-- 請選擇描述 --</option>
        <option value="__new__">➕ 新增描述</option>
      </select>
      <input type="text" id="newDescInput" placeholder="輸入新描述" style="display:none;">
      <br>

      <!-- 金額 -->
      <label>金額（日幣）：</label>
      <input type="number" id="yenInput" required><br>
      <label>換算台幣：</label>
      <span id="twdPreview">0</span> 元
      <br><br>

      <!-- 類型 -->
      <label>訂單類型：</label>
      <select name="type" required>
        <option value="到貨">到貨</option>
        <option value="預購">預購</option>
      </select><br>

      <!-- 匯款 -->
      <label>是否已匯款：</label>
      <select name="paid" required>
        <option value="是">是</option>
        <option value="否">否</option>
      </select><br>

      <input type="submit" value="送出訂單">
    </form>

    <h2>查詢訂單</h2>
    <form id="searchForm">
      <label>姓名：</label>
      <select name="name" id="nameSelect" required>
        <option value="">-- 請選擇姓名 --</option>
        <option value="__all__">📋 全部姓名</option>
      </select>
      <input type="submit" value="查詢">
    </form>
    <div id="result"></div>
  </div>

  <script>
    // 🔑 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyCPmkipseak3oKyfgPM-X8UkI9UKqv_cWA",
      authDomain: "chiikawa-6fccc.firebaseapp.com",
      projectId: "chiikawa-6fccc",
      storageBucket: "chiikawa-6fccc.appspot.com",
      messagingSenderId: "579094648440",
      appId: "1:579094648440:web:fa4699346b41317ea6ff8d",
      measurementId: "G-SGQ9XMLLYM"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ADMIN_PASSWORD = "abc123";
    let lastResults = [];

    window.checkPassword = function() {
      const input = document.getElementById("passwordInput").value;
      if (input === ADMIN_PASSWORD) {
        document.getElementById("app").style.display = "block";
        document.getElementById("passwordInput").style.display = "none";
        document.querySelector("button").style.display = "none";
        loadOptions();
      } else {
        alert("密碼錯誤");
      }
    };

    // 📋 載入姓名 / 品項 / 描述
    async function loadOptions() {
      let snapshot = await db.collection("orders").get();
      let names = new Set();
      let items = new Set();
      let descs = new Set();
      snapshot.forEach(doc => {
        const d = doc.data();
        if (d.name) names.add(d.name);
        if (d.item) items.add(d.item);
        if (d.desc) descs.add(d.desc);
      });

      // 姓名選單
      let orderNameSelect = document.getElementById("orderNameSelect");
      orderNameSelect.innerHTML = `<option value="">-- 請選擇姓名 --</option>`;
      names.forEach(n => orderNameSelect.innerHTML += `<option value="${n}">${n}</option>`);
      orderNameSelect.innerHTML += `<option value="__new__">➕ 新增姓名</option>`;

      // 品項選單
      let orderItemSelect = document.getElementById("orderItemSelect");
      orderItemSelect.innerHTML = `<option value="">-- 請選擇品項 --</option>`;
      items.forEach(i => orderItemSelect.innerHTML += `<option value="${i}">${i}</option>`);
      orderItemSelect.innerHTML += `<option value="__new__">➕ 新增品項</option>`;

      // 描述選單
      let orderDescSelect = document.getElementById("orderDescSelect");
      orderDescSelect.innerHTML = `<option value="">-- 請選擇描述 --</option>`;
      descs.forEach(d => orderDescSelect.innerHTML += `<option value="${d}">${d}</option>`);
      orderDescSelect.innerHTML += `<option value="__new__">➕ 新增描述</option>`;

      // 查詢用姓名選單
      let nameSelect = document.getElementById("nameSelect");
      nameSelect.innerHTML = `<option value="">-- 請選擇姓名 --</option><option value="__all__">📋 全部姓名</option>`;
      names.forEach(n => nameSelect.innerHTML += `<option value="${n}">${n}</option>`);
    }

    // 📝 新增訂單
    document.getElementById("orderForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      let selectedName = document.getElementById("orderNameSelect").value;
      if (selectedName === "__new__") {
        selectedName = document.getElementById("newNameInput").value.trim();
        if (!selectedName) return alert("請輸入新姓名！");
      }

      let selectedItem = document.getElementById("orderItemSelect").value;
      if (selectedItem === "__new__") {
        selectedItem = document.getElementById("newItemInput").value.trim();
        if (!selectedItem) return alert("請輸入新品項！");
      }

      let selectedDesc = document.getElementById("orderDescSelect").value;
      if (selectedDesc === "__new__") {
        selectedDesc = document.getElementById("newDescInput").value.trim();
        if (!selectedDesc) return alert("請輸入新描述！");
      }

      let yen = parseFloat(document.getElementById("yenInput").value);
      if (isNaN(yen) || yen <= 0) return alert("請輸入正確的日幣金額！");
      let amount = yen * 0.25;

      const order = {
        name: selectedName,
        item: selectedItem,
        desc: selectedDesc || "",
        amount: amount,
        type: document.querySelector("[name='type']").value,
        paid: document.querySelector("[name='paid']").value,
        time: new Date().toISOString()
      };

      try {
        await db.collection("orders").add(order);
        alert("訂單已送出！（金額已轉換成台幣）");
        this.reset();
        document.getElementById("twdPreview").innerText = "0";
        ["newNameInput","newItemInput","newDescInput"].forEach(id => document.getElementById(id).style.display="none");
        loadOptions();
      } catch (err) {
        console.error("送出失敗:", err);
        alert("送出失敗，請稍後再試。");
      }
    });

    // 即時換算
    document.getElementById("yenInput").addEventListener("input", function() {
      let yen = parseFloat(this.value);
      document.getElementById("twdPreview").innerText = isNaN(yen) ? "0" : (yen * 0.25).toFixed(2);
    });

    // 切換「新增輸入框」
    document.getElementById("orderNameSelect").addEventListener("change", function() {
      document.getElementById("newNameInput").style.display = this.value === "__new__" ? "inline" : "none";
    });
    document.getElementById("orderItemSelect").addEventListener("change", function() {
      document.getElementById("newItemInput").style.display = this.value === "__new__" ? "inline" : "none";
    });
    document.getElementById("orderDescSelect").addEventListener("change", function() {
      document.getElementById("newDescInput").style.display = this.value === "__new__" ? "inline" : "none";
    });

    // 🔍 查詢訂單
    document.getElementById("searchForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = new FormData(this).get("name");
      let resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";
      lastResults = [];

      let snapshot;
      if (name === "__all__") {
        snapshot = await db.collection("orders").orderBy("time", "desc").get();
      } else {
        snapshot = await db.collection("orders").where("name", "==", name).get();
      }

      if (!snapshot.empty) {
        let total = 0, unpaidTotal = 0;
        snapshot.forEach(doc => {
          const o = doc.data();
          lastResults.push({ id: doc.id, ...o });
          total += o.amount;
          if (o.paid === "否") unpaidTotal += o.amount;

          resultDiv.innerHTML += `
            <div class="order-card">
              <div class="order-info ${o.paid === "否" ? "unpaid" : ""}">
                <strong>${o.name}</strong> | 品項：${o.item}, 金額：${o.amount} TWD, 類型：${o.type}, 匯款：${o.paid}, 描述：${o.desc || "-"}, 時間：${o.time}
              </div>
              <button onclick="deleteOrder('${doc.id}')">刪除</button>
            </div>
          `;
        });
        resultDiv.innerHTML += `
          <div class="stats">
            <p><strong>總計：</strong> ${total.toFixed(2)} TWD</p>
            <p><strong>未匯款總計：</strong> <span class="unpaid">${unpaidTotal.toFixed(2)} TWD</span></p>
            <button class="export-btn" onclick="exportCSV()">📤 匯出 CSV</button>
          </div>
        `;
      } else {
        resultDiv.innerHTML = `<p>沒有找到訂單紀錄</p>`;
      }
    });

    // ❌ 刪除
    async function deleteOrder(id) {
      if (confirm("確定要刪除此訂單嗎？")) {
        await db.collection("orders").doc(id).delete();
        alert("訂單已刪除");
        document.getElementById("searchForm").dispatchEvent(new Event("submit"));
      }
    }

    // 📤 匯出 CSV
function exportCSV() {
  if (lastResults.length === 0) {
    alert("沒有資料可匯出！");
    return;
  }
  let csv = "姓名,品項,描述,金額(日幣),金額(台幣),類型,匯款,時間\n";
  lastResults.forEach(o => {
    let yen = (o.amount / 0.25).toFixed(0);
    csv += `${o.name},${o.item},${o.desc || ""},${yen},${o.amount},${o.type},${o.paid},${o.time}\n`;
  });

  // 加 BOM，避免 Excel 亂碼
  let bom = "\uFEFF";
  let blob = new Blob([bom + csv], { type: "text/csv;charset=utf-8;" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "orders.csv";
  link.click();
}

  </script>
</body>
</html>
