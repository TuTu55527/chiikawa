<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; padding: 20px; }
    h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
    form { background: #fff; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: inline-block; width: 120px; font-weight: bold; margin-bottom: 5px; }
    input, select { padding: 6px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; width: calc(100% - 130px); }
    input[type="submit"], button { width: auto; background: #007bff; color: white; border: none; cursor: pointer; padding: 6px 12px; border-radius: 4px; margin-top: 5px; }
    input[type="submit"]:hover, button:hover { background: #0056b3; }
    #result { margin-top: 15px; }
    .order-card { background: #fff; border-radius: 8px; padding: 10px; margin: 10px 0; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .order-info { max-width: 80%; }
    .unpaid { color: red; font-weight: bold; }
    .stats { background: #fff; padding: 10px; margin-top: 15px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>ğŸ”’ è¼¸å…¥å¯†ç¢¼ç™»å…¥</h2>
  <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
  <button onclick="checkPassword()">ç™»å…¥</button>

  <div id="app" style="display:none;">
    <h2>æ–°å¢è¨‚å–®</h2>
    <form id="orderForm">
      <label>å§“åï¼š</label>
      <select id="orderNameSelect" name="name" required>
        <option value="">-- è«‹é¸æ“‡å§“å --</option>
        <option value="__new__">â• æ–°å¢å§“å</option>
      </select>
      <input type="text" id="newNameInput" placeholder="è¼¸å…¥æ–°å§“å" style="display:none;">
      <br>

      <label>å“é …ï¼š</label>
      <select id="orderItemSelect" name="item" required>
        <option value="">-- è«‹é¸æ“‡å“é … --</option>
        <option value="__new__">â• æ–°å¢å“é …</option>
      </select>
      <input type="text" id="newItemInput" placeholder="è¼¸å…¥æ–°å“é …" style="display:none;">
      <br>

      <label>é‡‘é¡ï¼ˆæ—¥å¹£ï¼‰ï¼š</label>
      <input type="number" id="yenInput" required><br>
      <label>æ›ç®—å°å¹£ï¼š</label>
      <span id="twdPreview">0</span> å…ƒ
      <br><br>

      <label>è¨‚å–®é¡å‹ï¼š</label>
      <select name="type" required>
        <option value="åˆ°è²¨">åˆ°è²¨</option>
        <option value="é è³¼">é è³¼</option>
      </select><br>

      <label>æ˜¯å¦å·²åŒ¯æ¬¾ï¼š</label>
      <select name="paid" required>
        <option value="æ˜¯">æ˜¯</option>
        <option value="å¦">å¦</option>
      </select><br>

      <input type="submit" value="é€å‡ºè¨‚å–®">
    </form>

    <h2>æŸ¥è©¢è¨‚å–®</h2>
    <form id="searchForm">
      <label>å§“åï¼š</label>
      <select name="name" id="nameSelect" required>
        <option value="">-- è«‹é¸æ“‡å§“å --</option>
        <option value="__all__">ğŸ“‹ å…¨éƒ¨å§“å</option>
      </select>
      <input type="submit" value="æŸ¥è©¢">
    </form>
    <div id="result"></div>
  </div>

  <script>
    // ğŸ”‘ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCPmkipseak3oKyfgPM-X8UkI9UKqv_cWA",
      authDomain: "chiikawa-6fccc.firebaseapp.com",
      projectId: "chiikawa-6fccc",
      storageBucket: "chiikawa-6fccc.appspot.com",
      messagingSenderId: "579094648440",
      appId: "1:579094648440:web:fa4699346b41317ea6ff8d",
      measurementId: "G-SGQ9XMLLYM"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ADMIN_PASSWORD = "abc123";

    window.checkPassword = function() {
      const input = document.getElementById("passwordInput").value;
      if (input === ADMIN_PASSWORD) {
        document.getElementById("app").style.display = "block";
        document.getElementById("passwordInput").style.display = "none";
        document.querySelector("button").style.display = "none";
        loadOptions();
      } else {
        alert("å¯†ç¢¼éŒ¯èª¤");
      }
    };

    // ğŸ“‹ è¼‰å…¥å§“å & å“é …
    async function loadOptions() {
      let snapshot = await db.collection("orders").get();
      let names = new Set();
      let items = new Set();
      snapshot.forEach(doc => {
        names.add(doc.data().name);
        items.add(doc.data().item);
      });

      // å§“åï¼ˆæŸ¥è©¢ï¼‰
      let nameSelect = document.getElementById("nameSelect");
      nameSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡å§“å --</option><option value="__all__">ğŸ“‹ å…¨éƒ¨å§“å</option>`;
      names.forEach(n => {
        let opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });

      // å§“åï¼ˆæ–°å¢ï¼‰
      let orderNameSelect = document.getElementById("orderNameSelect");
      orderNameSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡å§“å --</option>`;
      names.forEach(n => {
        let opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        orderNameSelect.appendChild(opt);
      });
      orderNameSelect.innerHTML += `<option value="__new__">â• æ–°å¢å§“å</option>`;

      // å“é …
      let orderItemSelect = document.getElementById("orderItemSelect");
      orderItemSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡å“é … --</option>`;
      items.forEach(i => {
        let opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        orderItemSelect.appendChild(opt);
      });
      orderItemSelect.innerHTML += `<option value="__new__">â• æ–°å¢å“é …</option>`;
    }

    // ğŸ“ æ–°å¢è¨‚å–®
    document.getElementById("orderForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      let selectedName = document.getElementById("orderNameSelect").value;
      if (selectedName === "__new__") {
        selectedName = document.getElementById("newNameInput").value.trim();
        if (!selectedName) return alert("è«‹è¼¸å…¥æ–°å§“åï¼");
      }

      let selectedItem = document.getElementById("orderItemSelect").value;
      if (selectedItem === "__new__") {
        selectedItem = document.getElementById("newItemInput").value.trim();
        if (!selectedItem) return alert("è«‹è¼¸å…¥æ–°å“é …ï¼");
      }

      let yen = parseFloat(document.getElementById("yenInput").value);
      if (isNaN(yen) || yen <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ—¥å¹£é‡‘é¡ï¼");
      let amount = yen * 0.25; // å°å¹£

      const order = {
        name: selectedName,
        item: selectedItem,
        amount: amount,
        type: document.querySelector("[name='type']").value,
        paid: document.querySelector("[name='paid']").value,
        time: new Date().toISOString()
      };

      try {
        await db.collection("orders").add(order);
        alert("è¨‚å–®å·²é€å‡ºï¼ï¼ˆé‡‘é¡å·²è½‰æ›æˆå°å¹£ï¼‰");
        this.reset();
        document.getElementById("twdPreview").innerText = "0";
        document.getElementById("newNameInput").style.display = "none";
        document.getElementById("newItemInput").style.display = "none";
        loadOptions();
      } catch (err) {
        console.error("é€å‡ºå¤±æ•—:", err);
        alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    });

    // å³æ™‚æ›ç®—æ—¥å¹£ â†’ å°å¹£
    document.getElementById("yenInput").addEventListener("input", function() {
      let yen = parseFloat(this.value);
      document.getElementById("twdPreview").innerText = isNaN(yen) ? "0" : (yen * 0.25).toFixed(2);
    });

    // åˆ‡æ›è¼¸å…¥æ¡†
    document.getElementById("orderNameSelect").addEventListener("change", function() {
      document.getElementById("newNameInput").style.display = this.value === "__new__" ? "inline" : "none";
    });
    document.getElementById("orderItemSelect").addEventListener("change", function() {
      document.getElementById("newItemInput").style.display = this.value === "__new__" ? "inline" : "none";
    });

    // ğŸ” æŸ¥è©¢è¨‚å–®
    document.getElementById("searchForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const name = new FormData(this).get("name");
      let resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      let snapshot;
      if (name === "__all__") {
        snapshot = await db.collection("orders").orderBy("time", "desc").get();
      } else {
        snapshot = await db.collection("orders").where("name", "==", name).get();
      }

      if (!snapshot.empty) {
        let total = 0;
        let unpaidTotal = 0;
        snapshot.forEach(doc => {
          const o = doc.data();
          total += o.amount;
          if (o.paid === "å¦") unpaidTotal += o.amount;

          resultDiv.innerHTML += `
            <div class="order-card">
              <div class="order-info ${o.paid === "å¦" ? "unpaid" : ""}">
                <strong>${o.name}</strong> | å“é …ï¼š${o.item}, é‡‘é¡ï¼š${o.amount} TWD, é¡å‹ï¼š${o.type}, åŒ¯æ¬¾ï¼š${o.paid}, æ™‚é–“ï¼š${o.time}
              </div>
              <button onclick="deleteOrder('${doc.id}')">åˆªé™¤</button>
            </div>
          `;
        });

        resultDiv.innerHTML += `
          <div class="stats">
            <p><strong>ç¸½è¨ˆï¼š</strong> ${total.toFixed(2)} TWD</p>
            <p><strong>æœªåŒ¯æ¬¾ç¸½è¨ˆï¼š</strong> <span class="unpaid">${unpaidTotal.toFixed(2)} TWD</span></p>
          </div>
        `;
      } else {
        resultDiv.innerHTML = `<p>æ²’æœ‰æ‰¾åˆ°è¨‚å–®ç´€éŒ„</p>`;
      }
    });

    // âŒ åˆªé™¤è¨‚å–®
    async function deleteOrder(id) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ")) {
        await db.collection("orders").doc(id).delete();
        alert("è¨‚å–®å·²åˆªé™¤");
        document.getElementById("searchForm").dispatchEvent(new Event("submit")); // é‡æ–°æŸ¥è©¢
      }
    }
  </script>
</body>
</html>
